<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=0.8">
<title>Asset Locator + OCR + TTS + Media Gallery</title>
<script src="assets/tesseract.min.js"></script>
<script src="assets/html2canvas.min.js"></script>

<style>
/* --- FIX MOBILE DRAGGING --- */

html,
body {
	height: auto;
	overflow-x: hidden;
	overflow-y: auto;
}


/* prevent parallax layers from generating scroll area */

.parallax-layer,
.viz canvas,
.snowflake {
	position: fixed !important;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
}


/* lock internal containers inside screen */

.container {
	max-height: 100vh;
	overflow-y: auto;
	overscroll-behavior: auto;
	-webkit-overflow-scrolling: touch;
}

body {
	overflow: hidden;
	margin: 0;
	padding: 0;
}

canvas {
	display: block;
}


/* Snow effect */

.snowflake {
	position: fixed;
	top: -10px;
	color: #fff;
	font-size: 1em;
	z-index: 3;
	pointer-events: none;
	user-select: 0;
	opacity: 0.8;
	animation-name: fall;
	animation-timing-function: linear;
	animation-iteration-count: infinite;
}

@keyframes fall {
	0% {
		transform: translateY(-10px);
	}
	100% {
		transform: translateY(110vh);
	}
}

* {
	box-sizing: border-box;
	margin: 0;
	padding: 10px;
}

body {
	font-family: 'Roboto', sans-serif;
	min-height: 100vh;
	display: flex;
	flex-direction: column;
	transition: 0.25s;
	overflow-x: hidden;
	scroll-behavior: smooth;
}

/* === Neon Glow Accent Card Theme === */
body.dark .card {
  background: rgba(10, 20, 40, 0.4);
  border: 1px solid rgba(0, 255, 213, 0.3);
  box-shadow: 0 0 25px rgba(0, 255, 255, 0.35), inset 0 0 8px rgba(0, 255, 213, 0.15);
  color: #ccfaff;
  transition: all 0.4s ease;
}
body.light .card {
  background: #fefefe;
  border: 1px solid rgba(0, 0, 0, 0.7);
  box-shadow: 0 0 14px rgba(0, 180, 255, 0.45);
  color: #111;
  transition: all 0.4s ease;
}
body.dark .card:hover {
  box-shadow: 0 0 35px rgba(0, 255, 255, 0.45), inset 0 0 10px rgba(0, 255, 213, 0.2);
  transform: translateY(-3px);
}
body.light .card:hover {
  box-shadow: 0 0 18px rgba(0, 180, 255, 0.25);
  transform: translateY(-3px);
}

/* === Theme Button Neon Animation === */
#themeBtn {
  background: linear-gradient(145deg, #00ffff, #0072ff);
  color: #fff;
  border: none;
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
  transition: all 0.3s ease;
  animation: neonPulse 2.5s infinite alternate;
}
@keyframes neonPulse {
  0% {
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.5), 0 0 20px rgba(0, 255, 255, 0.6);
    transform: scale(1);
  }
  100% {
    box-shadow: 0 0 25px rgba(0, 255, 255, 0.8), 0 0 50px rgba(0, 255, 255, 0.6);
    transform: scale(1.05);
  }
}
#themeBtn:hover {
  transform: scale(1.1);
  filter: brightness(1.2);
}
body.light #themeBtn {
  background: linear-gradient(145deg, #555, #999);
  color: #fff;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.6);
  animation: none;
}
.parallax-layer {
	position: fixed;
	width: 100%;
	height: 100%;
	top: 0;
	left: 0;
	background-position: cover;
	background-size: cover;
	pointer-events: none;
	z-index: -3;
}

.parallax-top {
	background-image: url('assets/bga.gif');
	background-size: 100% auto;
	top: -100px;
	left: 0;
	z-index: -3;
}

.parallax-mid {
	background-image: url('assets/bgb.png');
	background-size: 50% auto;
	top: 0;
	left: 0;
	z-index: -2;
}

.parallax-bottom {
	background-image: url('assets/bgc.png');
	background-size: 50% auto;
	top: 0px;
	z-index: -1;
}
#previewContainer {
	width: 100%;
	display: flex;
	justify-content: center;
	align-items: center;
}

#topLogo {
	display: block;
	margin: 12px auto;
	width: 80%;
	border-radius: 20px;
	box-shadow: 0 10px 40px rgba(0, 255, 255, 0.5), 0 0 20px rgba(0, 255, 255, 0.3);
	border: 3px solid rgba(0, 255, 255, 0.6);
	animation: fadePulse 3s ease-in-out infinite;
}

@keyframes fadePulse {
	20% {
		opacity: 1;
		filter: drop-shadow(0 0 8px rgba(0, 255, 255, 0.7));
	}
	50% {
		opacity: 0.1;
		filter: drop-shadow(0 0 2px rgba(0, 255, 255, 0.2));
	}
	100% {
		opacity: 1;
		filter: drop-shadow(0 0 8px rgba(0, 255, 255, 0.7));
	}
}

#viewerIframe {
	width: 100%;
	aspect-ratio: 4 / 2;
	border: 4px solid #48CA68;
	border-radius: 20px;
	background: #000;
	min-height: 130px;
	transition: all 0.6s ease;
}

body.light #viewerIframe {
	border-color: #111;
}

.container {
	padding: 4px;
	max-width: 580px;
	margin: 0 auto 50px;
	display: flex;
	flex-direction: column;
	gap: 12px;
}

h1,
h3 {
	text-align: center;
	text-shadow: 0 2px 6px rgba(0, 200, 255, .3);
}

h3 {
	margin-top: 14px;
}

.card {
	background: rgba(15, 25, 40, .55);
	border-radius: 16px;
	padding: 14px;
	box-shadow: 0 6px 20px rgba(0, 200, 255, .3);
	transition: 0.3s;
}

body.light .card {
	background: #868798;
	box-shadow: 0 6px 20px #B9CBCC60;
}

.card:hover {
	box-shadow: 0 8px 28px rgba(0, 255, 255, .45);
}

input,
textarea {
	width: 100%;
	padding: 12px;
	border-radius: 12px;
	background: #0f1928;
	border: 1px solid #334;
	color: #e6eef8;
	font-family: monospace;
	outline: none;
}

body.light input,
body.light textarea {
	background: #454545;
	border: 1px solid #ccc;
	color: #111;
}

textarea {
	min-height: 80px;
	max-height: 200px;
	resize: none;
}

button {
	padding: 12px 18px;
	border-radius: 14px;
	border: none;
	font-weight: 600;
	cursor: pointer;
	transition: 0.25s;
	box-shadow: 0 4px 12px rgba(0, 255, 255, .);
	background: linear-gradient(145deg, #303a44, #111418);
	color: #2C2D2F;
}

body.light button {
	background: #eee;
	color: #111;
	box-shadow: 0 4px 12px rgba(0, 255, 0, .6);
}

button:hover {
	transform: translateY(-3px) scale(1.05);
}

button:active {
	transform: translateY(0) scale(0.98);
}

.asset-btn {
	background: linear-gradient(145deg, #0a1e2c, #0c2c3e);
	color: #00ffff;
	border: 1px solid rgba(0, 255, 255, .3);
	font-size: 1em;
	margin: 4px;
	padding: 10px 16px;
	border-radius: 12px;
}

body.light .asset-btn {
	background: #ddd;
	color: #111;
	border: 1px solid #999;
}

.tiny-btn {
	padding: 6px 10px;
	font-size: 0.9em;
	border-radius: 12px;
}

#copyBtn {
	background: linear-gradient(135deg, #00b4ff, #0072ff);
	color: #fff;
	font-weight: 700;
	border: none;
	border-radius: 14px;
	padding: 10px 20px;
	box-shadow: 0 4px 12px rgba(0, 200, 255, .4);
	transition: all 0.3s ease;
}

#copyBtn:hover {
	transform: scale(1.05);
	box-shadow: 0 6px 18px rgba(0, 255, 255, .5);
}

body.light #copyBtn {
	background: linear-gradient(135deg, #555, #999);
	color: #fff;
}

#operatorTitle {
	font-size: 2.6em;
	text-align: center;
	font-weight: 900;
	margin: 10px 0;
	color: #CC0776;
	background: linear-gradient(90deg, #ff00aa, #9d00ff);
	-webkit-background-clip: text;
}

#ocrLoader {
	display: none;
	margin: 12px auto;
	width: 50px;
	height: 50px;
	border: 6px solid rgba(255, 255, 255, 0.15);
	border-top: 6px solid #00b4ff;
	border-radius: 50%;
	animation: spin 1.1s linear infinite;
}

@keyframes spin {
	0% {
		transform: rotate(0deg);
	}
	100% {
		transform: rotate(360deg);
	}
}

.flex-row {
	display: flex;
	gap: 8px;
	flex-wrap: wrap;
}

.flex-col {
	display: flex;
	flex-direction: column;
	gap: 8px;
}


#mediaBtn {
	position: fixed;
	top: 12px;
	left: 9px;
	padding: 5px 16px;
	border-radius: 16px;
	font-weight: 700;
	box-shadow: 0 4px 8px #A94FCC50;
	cursor: pointer;
	transition: 0.3s;
}

#themeBtn {
	right: 10px;
	background: linear-gradient(145deg, #ff00aa, #9d00ff);
	color: #fff;
}

body.light #themeBtn {
	background: #ccc;
	color: #111;
	box-shadow: 4px 8px 16px #CC3D4E;
}

#mediaBtn {
	left: 5px;
	background: linear-gradient(145deg, #00ffdc, #00b4ff);
	color: #000;
}

body.light #mediaBtn {
	background: #888;
	color: #fff;
	box-shadow: 0 4px 12px #A94FCC50;
}

.bottom-nav {
	position: fixed;
	bottom: 0;
	left: 0;
	width: 100%;
	background: rgba(15, 25, 40, 0.95);
	display: flex;
	justify-content: space-around;
	padding: 10px 0;
	box-shadow: 0 -4px 20px rgba(0, 255, 255, .3);
	z-index: 100;
}

body.light .bottom-nav {
	background: #eee;
	box-shadow: 0 -4px 20px rgba(0, 0, 0, .1);
}

.nav-btn {
	flex: 1;
	text-align: center;
	color: #fff;
	font-size: 0.7em;
	border: none;
	background: none;
	cursor: pointer;
	transition: 0.5s;
}

body.light .nav-btn {
	color: #111;
}

.nav-btn:hover {
	color: #00d0ff;
	transform: scale(1.1);
}

#mediaModal {
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: rgba(0, 0, 0, .85);
	display: none;
	justify-content: center;
	align-items: center;
	z-index: 102;
}

#menuModal {
	background: rgba(15, 25, 40, .95);
	padding: 12px;
	border-radius: 16px;
	display: grid;
	grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* responsive columns */
	justify-items: center;  /* centers each button horizontally */
	align-items: start;     /* keeps top-aligned layout */
	gap: 16px;              /* more breathing room */
	width: 95%;
	max-height: 90%;
	margin: 0 auto;
	overflow-y: auto;
	box-sizing: border-box;
}
#menuModal button {
	display: flex;
	flex-direction: column;
	align-items: center;
	justify-content: flex-start;
	background: #0f1928;
	color: #00e0ff;
	border: none;
	border-radius: 12px;
	padding: 8px;
	width: 100%;
	max-width: 180px; /* optional, prevents oversized tiles */
	box-sizing: border-box;
	transition: transform 0.25s, opacity 0.25s;
	cursor: pointer;
}
#menuModal button img {
	width: 130%;
	height: auto;
	border-radius: 8px;
}
#menuModal button span {
	margin-top: 6px;
	font-size: 0.9em;
	text-align: center;
	word-wrap: break-word;
}

.pdf-submenu {
	grid-column: 1/-1;
	background: #2563eb;
	color: #fff;
	opacity: 1;
	cursor: pointer;
	text-align: center;
}

#selectedModal {
	position: fixed;
	top: 5%;
	left: 5%;
	width: 90%;
	height: 90%;
	background: rgba(0, 0, 0, .95);
	display: none;
	justify-content: center;
	align-items: center;
	z-index: 103;
	border-radius: 8px;
	overflow: hidden;
}

#selectedModal img {
	width: 100%;
	height: 100%;
	object-fit: contain;
	cursor: grab;
	user-select: none;
	pointer-events: all;
}

#closeModal {
	position: absolute;
	top: 12px;
	right: 16px;
	background: url('assets/silver-stby.png') no-repeat center center/contain;
	color: #000;
	border: none;
	border-radius: 50%;
	width: 66px;
	height: 66px;
	font-size: 30px;
	cursor: pointer;
	z-index: 104;
	box-shadow: 0 0 12px rgba(0, 0, 0, .6);
}

#closeModal:hover {
	background-color: #eee;
}

#modalPrev {
	position: absolute;
	top: 50%;
	left: 10px;
	transform: translateY(-50%);
	background: url('assets/leftvarrow.png') no-repeat center center/contain;
	border: none;
	border-radius: 50%;
	width: 40px;
	height: 40px;
	cursor: pointer;
	box-shadow: 0 0 12px rgba(0, 0, 0, .6);
	z-index: 105;
}

#modalNext {
	position: absolute;
	top: 50%;
	right: 10px;
	transform: translateY(-50%);
	background: url('assets/rightarrow.png') no-repeat center center/contain;
	border: none;
	border-radius: 50%;
	width: 40px;
	height: 40px;
	cursor: pointer;
	box-shadow: 0 0 12px rgba(0, 0, 0, .6);
	z-index: 105;
}

#modalShare {
	position: absolute;
	bottom: 10px;
	right: 10px;
	background: url('assets/dl.png') no-repeat center center/contain;
	border: none;
	border-radius: 50%;
	width: 80px;
	height: 80px;
	cursor: pointer;
	box-shadow: 0 0 12px rgba(0, 0, 0, .6);
	z-index: 105;
}

#modalPrev:hover,
#modalNext:hover,
#modalShare:hover {
	background-color: #00b4ff;
}

.viz canvas {
	position: fixed;
	top: 0px;
	left: 0px;
	width: 100%;
	height: 100%;
	opacity: 0.6;
	z-index: -2;
	pointer-events: none;
}
/* ===== GARAGE REFERENCE ‚Äì ISOLATED ===== */

#garageRefBtn {
  background-image: url('assets/depot.webp');
  background-size: cover;      /* fill the button */
  background-position: center; /* center the image */
  background-repeat: no-repeat;
  border: none;
  padding: 10px;
  width: 90px;
  height: 90px;
  position: fixed
  top: 12px;
  left: %;
  z-index: 100;
  cursor: pointer;
  border-radius: 26px;
  box-shadow: 4px 8px 20px #7A30CC;
}

#garageRefModal{
  position:fixed;
  inset:0;
  display:none;
  background:rgba(0,0,0,.3);
  z-index:110;
}

#garageRefBox{
  position:absolute;
  inset:5%;
  background:#0d1117;
  border-radius:16px;
  box-shadow:0 0 40px rgba(0,255,213,.4);
  overflow-y:auto;      /* enables vertical scrolling */
  overflow-x:hidden;    /* prevents sideways scroll */
  max-height:84vh;      /* keeps modal within viewport */
}

#garageRefBox::-webkit-scrollbar {
  width: 8px;
}
#garageRefBox::-webkit-scrollbar-thumb {
  background: rgba(0,255,213,0.4);
  border-radius: 8px;
}

#garageRefBox iframe{
  width:100%;
  height:100%;
  border:none;
}

#garageRefClose{
  position:absolute;
  top:10px;
  right:34px;
  z-index:2;
  border:none;
  background:##00302860;
  font-size:22px;
  font-weight:700;
  padding:6px 15px;
  border-radius:8px;
  cursor:pointer;
}
/* --- Button Titles (Fixed Buttons) --- */
.fixed-btn {
  position: relative;
  display: inline-block;
  text-align: center;
}

.fixed-btn::after {
  content: attr(data-title);
  position: absolute;
  bottom: -22px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.2em;
  color: #CAD8F1;
  text-shadow: 3px 3px 3px #212121;
  white-space: nowrap;
  font-weight: 600;
}

body.light .fixed-btn::after {
  color: #111;
  text-shadow: none;
}
.btn-3d {
  background-image: url('assets/bgrem.gif');
  background-size: cover;      /* fill the button */
  background-position: center; /* center the image */
  background-repeat: no-repeat;
  border: 2px;
  padding: 10px;
  width: 90px;
  height: 90px;
  position: fixed;
  top: 130px;
  left: 10px;
  z-index: 101;
  cursor: pointer;
  border-radius: 26px;
  box-shadow: 4px 8px 20px #7A30CC;
}

.btn-3d:active {
  transform: translateY(6px);
  box-shadow:
    0 6px 0 #123a80,
    0 6px 12px rgba(0,0,0,0.6);
}

/* Overlay */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.75);
  display: none;
  align-items: right;
  justify-content: center;
  z-index: 1000;
}

.overlay.active {
  display: flex;
}

.iframe-container {
  position: relative;
  width: 90vw;
  height: 90vh;
  background: #000;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 20px 50px rgba(0,0,0,0.8);
}

.iframe-container iframe {
  width: 100%;
  height: 100%;
  border: none;
}

/* Close button */
.close-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #ff4d4d;
  color: #fff;
  font-size: 20px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.6);
}

</style>
</head>
<body class="dark">
<div class="viz"></div>
<div class="viz canvas">‚ùÑÔ∏è‚ùÑÔ∏è‚ùÑÔ∏è</div>
<body>  
<div class="btn-3d" id="openBtn">.......BG REMOVER</div>
  <div class="overlay" id="overlay">
    <div class="iframe-container">
      <div class="close-btn" id="closeBtn">√ó</div>
      <iframe src="assets/bg-rem.html"></iframe>
    </div>
  </div>  


<!-- PARALLAX LAYERS -->
<div class="parallax-layer parallax-top"></div>
<div class="parallax-layer parallax-mid"></div>
<div class="parallax-layer parallax-bottom"></div>
<!-- FLOATING BUTTONS -->
<button id="mediaBtn" class="fixed-btn" data-title="Media" style="background:none;border:none;padding:0;width:90px;height:90px;position:fixed;top:12px;left:12px;z-index:101;cursor:pointer;">
  <img src="assets/info.webp" alt="Media Menu" style="width:100%;height:100%;border-radius:16px;box-shadow:0 4px 8px #A94FCC50;">
</button>

<button id="themeBtn" class="fixed-btn" data-title="Theme" style="background:none;border:none;padding:0;width:90px;height:90px;position:fixed;top:12px;right:10px;z-index:101;cursor:pointer;">
  <img src="assets/theme.webp" alt="Theme" style="width:100%;height:100%;border-radius:16px;box-shadow:0 4px 12px #5D714750;">
</button>

<div class="container">
<DL>
</DL>
<DL>
</DL>
<h3><p>C.W Companion</h3></p><p><h1><span style="color: red"></p>Asset Locator OCR</h1></span>
<img id="topLogo" src="assets/toplogo.gif">
<div class="card flex-row" style="justify-content:center;">
  <label for="fileInput" class="tiny-btn" style="
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    display: inline-block;">
    <img src="assets/cw.webp" alt="Open Image" style="width:180px;height:auto;border-radius:12px;box-shadow:0 4px 12px rgba(0,255,255,.3);">
  </label>
  <input type="file" id="fileInput" accept="image/*" style="display:none;">
<button id="clearBtn" style="
  background: none;
  border: none;
  padding: 0;
  width: 60px;
  height: 60px;
  position: right;
  top: 5px;
  right: 15px;
  cursor: pointer;">
  <img src="assets/clear.gif" alt="Theme" style="width:100%;height:100%;border-radius:16px;box-shadow:0 4px 12px rgba(0,255,255,.3);">
</button>
</div>
<div class="card">
<h3>OCR Preview</h3>
<div id="ocrPreview"[+Buttons] = When OCR results appear here, Press the "+Button" to Generate Buttons. Remember 'No Asset numbers in OCR data = No Buttons'...</div>
<div id="ocrLoader"></div>
</div>
<div class="card flex-col" style="align-items:center;">
  <textarea id="inputText" placeholder="OCR Results + Or Add more Fleet numbers manually...." style="width:90%;"></textarea>


    <!-- Left: Generate -->
    <button id="generateBtn" style="
      background:none;
      border:none;
      padding:0;
      width:80px;
      height:80px;
      cursor:pointer;">
      <img src="assets/gen.webp" alt="Generate"
           style="width:100%;height:100%;border-radius:16px;
           box-shadow:0 4px 12px rgba(0,255,255,.3);">
    </button>

    <!-- Center: Insert OCR -->
    <button id="insertOCRBtn" style="
      background:none;
      border:none;
      padding:0;
      width:120px;
      height:120px;
      cursor:pointer;">
      <img src="assets/add.webp" alt="InsertOCR"
           style="width:100%;height:100%;border-radius:16px;
           box-shadow:0 4px 12px rgba(0,255,255,.3);">
    </button>

    <!-- Right: TTS + Pause stacked -->
    <div style="
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;">
      
      <button id="ttsBtn" style="
        background:none;
        border:none;
        padding:0;
        width:70px;
        height:70px;
        cursor:pointer;">
        <img src="assets/tts.png" alt="üîàRead"
             style="width:100%;height:100%;border-radius:16px;
             box-shadow:0 4px 12px rgba(0,255,255,.3);">
      </button>

      <button id="pauseBtn" style="
        background:none;
        border:none;
        padding:0;
        width:60px;
        height:10px;
        font-size:1.8em;
        color:#00ffff;
        cursor:pointer;">‚è∏Ô∏è</button>
    </div>

  </div>
</div>
<h2>Preview</h2>
<div id="operatorTitle">Abellio</div>
<div id="previewContainer"><iframe id="viewerIframe"></iframe></div>
<div class="operator-track">
<button class="operatorBtn active" data-name="Abellio" data-template="https://lvf.io/#LDN|TL" data-color="#ef4444">Abellio</button>
<button class="operatorBtn" data-name="Go-Ahead" data-template="https://lvf.io/#LDN|GAL" data-color="#2563eb">Go-Ahead</button>
<button class="operatorBtn" data-name="Stagecoach" data-template="https://lvf.io/#LDN|SLN" data-color="#f97316">Stagecoach</button>
<button class="operatorBtn" data-name="Metroline" data-template="https://lvf.io/#LDN|ML" data-color="#991b1b">Metroline</button>
<button class="operatorBtn" data-name="Arriva" data-template="https://lvf.io/#LDN|AL" data-color="#06b6d4">Arriva</button>
</div>
<div class="card">
<h3>Generated Buttons</h3>
<div id="buttonsContainer"></div>
</div>
<div class="card">
<h3>Extracted Fleet Numbers</h3>
<div id="resultsBox">No results yet.</div>
<div style="text-align:center;">
<button id="exportTxtBtn"
style="
display:inline-flex;
align-items:center;
justify-content:center;
gap:12px;
padding:16px 28px;
font-size:20px;
font-weight:700;
background:#45004F40;
border:2px solid black;
border-radius:12px;
color:transparent;
background-clip:text;
-webkit-background-clip:text;
text-fill-color:transparent;
-webkit-text-fill-color:transparent;
background-image:linear-gradient(45deg, purple, #8AB7E3);
box-shadow:4px 8px 20px rgba(0,255,0,0.5);
cursor:pointer;
margin-top:20px;
transition:transform 0.5s ease;
flex-wrap:wrap;
"
onmouseover="this.style.transform='scale(1.25)'"
onmouseout="this.style.transform='scale(1)'"
>
  <div style="display:flex;flex-direction:column;align-items:center;line-height:1.1;">
    <h2 style="margin:0;font-size:22px;">Export As Text</h2>
    <h4 style="margin:0;font-size:15px;">Clockwork_[date].txt</h4>
  </div>
  <img src="assets/dldown.png" alt="Download" style="width:70px;height:80px;object-fit:contain;">
</button>
</div>
<div style="text-align:center;"><button id="copyBtn">Copy Fleet Numbers</button></div>
<div style="text-align:center;"><button id="exportImgBtn">Export Preview</button></div>
</div>
</div>
<div class="bottom-nav">
<button class="nav-btn" onclick="scrollToSection('ocrPreview')">OCR</button>
<button class="nav-btn" onclick="scrollToSection('inputText')">Input</button>
<button class="nav-btn" onclick="scrollToSection('buttonsContainer')">Fleet</button>
<button class="nav-btn" onclick="scrollToSection('previewContainer')">Preview</button>
</div>
<div id="mediaModal">
<div id="menuModal"></div>
<div id="selectedModal">
<button id="closeModal"></button>
<img id="modelImage" src="jfs.png" alt="Model Image">
<button id="modalPrev"></button>
<button id="modalNext"></button>
<button id="modalShare"></button>
</div>
</div>
<button id="" class=""></button>

<button id="loginnRefBtn" class="fixed-btn" data-title="Login" style="background:none;border:none;padding:0;width:90px;height:90px;position:fixed;top:15px;right:28%;z-index:101;cursor:pointer;">
  <img src="assets/login.webp" alt="Login Reference" style="width:100%;height:100%;border-radius:16px;box-shadow:0 4px 12px rgba(0,255,255,.3);">
</button>

<div id="loginnRefModal" class="ref-modal">
  <div class="ref-modal-content">
    <span class="close">&times;</span>
    <div id="buttonBar" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-bottom:10px;">
      <button id="editSaveBtn" class="action-btn green-btn">Edit</button>
      <button id="insertImgBtn" class="action-btn">Insert Image</button>
      <button id="clearAllBtn" class="action-btn red-btn">Clear All</button>
      <button id="exitBtn" class="action-btn">Exit</button>
      <button id="undoBtn" class="action-btn yellow-btn">Undo</button>
      <button id="redoBtn" class="action-btn yellow-btn">Redo</button>
      <button id="exportBtn" class="action-btn blue-btn">Export PDF</button>
      <input type="file" id="imgInput" accept="image/*" style="display:none;">
    </div>
    <div id="notebookContainer">
      <div id="notebook" contenteditable="false"></div>
    </div>
  </div>
</div>

<style>
.ref-btn {
  position:absolute; 
  top:12px; 
  width:90px; 
  height:90px;
  background-image: url('assets/login.webp'); /* ‚Üê add this */
  background-size:cover; 
  background-position:center; 
  background-repeat:no-repeat;
  border:3px solid #00bcd4; 
  border-radius:12px; 
  cursor:pointer; 
	z-index: 100;
  transition:0.3s;
  right:25%;
}

.ref-btn:hover { filter: brightness(1.1); }

.ref-modal { display:none; position:fixed; z-index:9999; left:0; top:0; width:100%; height:100%; background: rgba(0,0,0,0.7); }
.ref-modal-content { display:flex; flex-direction:column; position:relative; background:#fff; margin:10px auto; padding:5px; border-radius:12px;
  width:98%; height:90%; max-width:98%; box-shadow:5px 10px 30px rgba(0,0,0,0.5); }
.close { color:#000; font-size:38px; font-weight:bold; cursor:pointer; }
.close:hover { color:red; }

.action-btn {
  flex:1 1 auto; min-width:100px; padding:20px; font-size:18px;
  border:none; border-radius:12px; font-weight:bold; box-shadow:5px 5px 10px #888, -5px -5px 10px #fff;
  cursor:pointer; transition:all 0.2s ease; color:#fff;
}
.green-btn { background:linear-gradient(145deg,#4CAF50,#388E3C); }
.red-btn { background:linear-gradient(145deg,#F44336,#D32F2F); }
.yellow-btn { background:linear-gradient(145deg,#FFEB3B,#FBC02D); color:#000; }
.blue-btn { background:linear-gradient(145deg,#2196F3,#1976D2); }
.action-btn:hover { filter: brightness(1.1); transform: translateY(1px); }
.action-btn:active { transform: translateY(2px); box-shadow: inset 2px 2px 5px #555, inset -2px -2px 5px #fff; }

#notebookContainer { flex:1; overflow:auto; margin-top:5px; }
#notebook {
  width:100%; height:100%; padding:15px; overflow:auto;
  border:1px solid #ccc; border-radius:8px;
  background: repeating-linear-gradient(to bottom,#fff8dc,#fff8dc 29px,#3D1C48 30px);
  font-family:'Courier New', monospace; font-size:20px; line-height:30px; white-space:pre-wrap;
  outline:none; position:relative;
}
.img-wrapper { position:absolute; display:inline-block; }
.img-wrapper img { max-width:150px; border:5px solid #888; border-radius:4px; touch-action:none; }
.handle {
  width:50px; height:45px; background:#00bcd4; color:#fff; font-weight:bold;
  text-align:center; line-height:25px; border-radius:50%; font-size:18px;
  position:absolute; bottom:-10px; right:-10px; cursor:grab; user-select:none; z-index:1000;
}
/* === FINAL NEON THEME OVERRIDE (MUST BE LAST) === */
body.dark .card {
  background: rgba(10, 20, 40, 0.9);
  border: 1px solid rgba(0, 255, 213, 0.3);
  box-shadow: 0 0 25px rgba(0, 255, 255, 0.25), inset 0 0 8px rgba(0, 255, 213, 0.15);
  color: #ccfaff;
  transition: all 0.4s ease;
}

body.light .card {
  background: #fefefe;
  border: 1px solid rgba(0, 0, 0, 0.1);
  box-shadow: 0 0 14px rgba(0, 180, 255, 0.15);
  color: #111;
  transition: all 0.4s ease;
}

#themeBtn {
  background: linear-gradient(145deg, #00ffff, #0072ff);
  color: #fff;
  border: none;
  box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
  animation: neonPulse 2.5s infinite alternate;
  transition: all 0.3s ease;
}

@keyframes neonPulse {
  0% {
    box-shadow: 0 0 10px rgba(0, 255, 255, 0.5), 0 0 20px rgba(0, 255, 255, 0.3);
    transform: scale(1);
  }
  100% {
    box-shadow: 0 0 25px rgba(0, 255, 255, 0.8), 0 0 50px rgba(0, 255, 255, 0.5);
    transform: scale(1.05);
  }
}

body.light #themeBtn {
  background: linear-gradient(145deg, #555, #999);
  color: #fff;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
  animation: none;
}
</style>


<!-- ===== GARAGE REFERENCE BUTTON ===== -->
<button id="garageRefBtn" class="fixed-btn" data-title="Garage" style="background:none;border:none;padding:0;width:90px;height:90px;position:fixed;top:12px;left:28%;z-index:101;cursor:pointer;">
  <img src="assets/depot.gif" alt="Garage Reference" style="width:100%;height:100%;border-radius:16px;box-shadow:0 4px 12px rgba(0,255,255,.3);">
</button>

<!-- ===== GARAGE REFERENCE MODAL ===== -->
<div id="garageRefModal">
  <div id="garageRefBox">
    <button id="garageRefClose">‚úï</button>

    <iframe
      srcdoc='<!-- Garage Fleet Table Snippet with Fleet Vehicles -->

<style>
  #garageSearch { width:25%; padding:8px; font-size:16px; margin-bottom:12px; }
  table#garageTable { width:100%; border-collapse:collapse; font-family:Arial,sans-serif; }
  table#garageTable th, table#garageTable td { border:1px solid #ccc; padding:8px; font-size:14px; vertical-align:top; }
  table#garageTable th { background:#eee; }
  .fleet-cell {
    max-height:60px; /* 3 lines visible approx */
    overflow-y:auto; 
    position:relative; 
  }
  .fleet-cell::after {
    content:"‚Üì"; position:absolute; bottom:2px; right:6px; font-size:12px; opacity:0.6;
  }
  .op-abellio { color:#0066CC; font-weight:bold; font-size:1.1em; }
  .op-metroline { color:#0056A4; font-weight:bold; font-size:1.1em; }
  .op-stagecoach { color:#3366FF; font-weight:bold; font-size:1.1em; }
  .op-first { color:#800080; font-weight:bold; font-size:1.1em; }
  .op-arriva { color:#009933; font-weight:bold; font-size:1.1em; }
  .none { font-style:italic; color:grey; }
</style>

<input type="text" id="garageSearch" placeholder="Search by garage, fleet number or reg‚Ä¶" onkeyup="filterGarages(this.value)">

<table id="garageTable">
  <thead>
    <tr><th>Operator</th><th>Garage</th><th>Address</th><th>Fleet Vehicles</th></tr>
  </thead>
  <tbody>

    <!-- Extra Vital Addresses -->
    <tr>
      <td class="op-stagecoach">Stagecoach</td>
      <td>Barking Bus Garage</td>
      <td><a href="https://maps.app.goo.gl/AosKzkoviWopGRxV7" target="_blank">Longbridge Rd, London IG11 8UE</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>
    <tr>
      <td class="op-stagecoach">Stagecoach</td>
      <td>Walthamstow Ave Bus Garage (Nr A406)</td>
      <td><a href="https://maps.app.goo.gl/1oFKtUUEXQHZgshJ7" target="_blank">Walthamstow Avenue, London</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>
    <tr>
      <td class="op-stagecoach">Stagecoach</td>
      <td>Leyton Bus Garage</td>
      <td><a href="https://maps.app.goo.gl/TRJzk8kfRa8qDSNL9" target="_blank">Leyton, London</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>
    <tr>
      <td class="op-arriva">Arriva</td>
      <td>Hackney Central Bus Garage</td>
      <td><a href="https://maps.app.goo.gl/oyXMxhiecj9GPx387" target="_blank">Hackney Central, London</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>
    <tr>
      <td class="op-arriva">Arriva</td>
      <td>Norwood Bus Garage</td>
      <td><a href="https://maps.app.goo.gl/BFoTiHCoQAW6J1Bz6" target="_blank">Norwood, London</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>
    <tr>
      <td class="op-arriva">Arriva</td>
      <td>Tottenham Bus Garage</td>
      <td><a href="https://maps.app.goo.gl/fNu1QowXvQdBwLRy8" target="_blank">Tottenham, London</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>
    <tr>
      <td class="op-goahead">Go-Ahead</td>
      <td>Barking River Road</td>
      <td><a href="https://maps.app.goo.gl/RtEq8yB6PA71gTaw9" target="_blank">51 River Rd., London IG11 0DA</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>
    <tr>
      <td class="op-goahead">Go-Ahead</td>
      <td>Camberwell Bus Garage</td>
      <td><a href="https://maps.app.goo.gl/cV8VbsjmmbAhy4WY8" target="_blank">20 Warner Rd, London SE5 9LU</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>
    <tr>
      <td class="op-stagecoach">Stagecoach</td>
      <td>Merton Bus Garage</td>
      <td><a href="https://maps.app.goo.gl/h5r1CnMzsGjvfRYf9" target="_blank">21 Leyton Rd, London SW19 1DJ</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <!-- Battersea -->
    <tr>
      <td class="op-abellio">Transport UK London Bus</td>
      <td>Battersea</td>
      <td><a href="https://maps.google.com/?q=Silverthorne+Road,+Battersea,+London,+SW8+3HE" target="_blank">Silverthorne Road, SW8 3HE</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <!-- Beddington -->
    <tr>
      <td class="op-abellio">Transport UK London Bus</td>
      <td>Beddington</td>
      <td><a href="https://maps.google.com/?q=Unit+10,+Beddington+Cross,+Beddington+Farm+Road,+Croydon,+CR0+4XH" target="_blank">Beddington Farm Road, CR0 4XH</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <!-- Walworth -->
    <tr>
      <td class="op-abellio">Transport UK London Bus</td>
      <td>Walworth</td>
      <td><a href="https://maps.google.com/?q=301+Camberwell+New+Road,+London,+SE5+0TF" target="_blank">301 Camberwell New Road, SE5 0TF</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <!-- Battersea -->
    <tr>
      <td class="op-abellio">Transport UK London Bus</td>
      <td>Battersea</td>
      <td><a href="https://maps.google.com/?q=Silverthorne+Road,+Battersea,+London,+SW8+3HE" target="_blank">Silverthorne Road, SW8 3HE</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <!-- Beddington -->
    <tr>
      <td class="op-abellio">Transport UK London Bus</td>
      <td>Beddington</td>
      <td><a href="https://maps.google.com/?q=Unit+10,+Beddington+Cross,+Beddington+Farm+Road,+Croydon,+CR0+4XH" target="_blank">Beddington Farm Road, CR0 4XH</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <!-- Walworth -->
    <tr>
      <td class="op-abellio">Transport UK London Bus</td>
      <td>Walworth</td>
      <td><a href="https://maps.google.com/?q=301+Camberwell+New+Road,+London,+SE5+0TF" target="_blank">301 Camberwell New Road, SE5 0TF</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <!-- Twickenham -->
    <tr>
      <td class="op-abellio">Transport UK London Bus</td>
      <td>Fulwell (Twickenham)</td>
      <td><a href="https://maps.google.com/?q=The+Old+Tram+Depot,+Stanley+Road,+Twickenham,+TW2+5NP" target="_blank">Stanley Road, TW2 5NP</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <!-- Southall -->
    <tr>
      <td class="op-abellio">Transport UK London Bus</td>
      <td>Southall (Armstrong Way)</td>
      <td><a href="https://maps.google.com/?q=Armstrong+Way,+Southall,+UB2+4SD" target="_blank">Armstrong Way, UB2 4SD</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <!-- Hayes -->
    <tr>
      <td class="op-abellio">Transport UK London Bus</td>
      <td>Hayes</td>
      <td><a href="https://maps.google.com/?q=Dawley+Road,+Hayes,+UB3+1EF" target="_blank">Dawley Road, Hayes, UB3 1EF</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <!-- Metroline garages -->
    <tr>
      <td class="op-metroline">Metroline</td>
      <td>Athlon Road</td>
      <td><a href="https://maps.google.com/?q=Capital+Business+Centre,+Athlon+Road,+Wembley,+HA0+1YU" target="_blank">Capital Business Centre, Athlon Road, HA0 1YU</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <tr>
      <td class="op-metroline">Metroline</td>
      <td>Brentford</td>
      <td><a href="https://maps.google.com/?q=Commerce+Road,+Brentford,+TW8+8LZ" target="_blank">Commerce Road, TW8 8LZ</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <tr>
      <td class="op-metroline">Metroline</td>
      <td>Cricklewood</td>
      <td><a href="https://maps.google.com/?q=329+Edgware+Road,+Cricklewood,+NW2+6JP" target="_blank">329 Edgware Road, NW2 6JP</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <tr>
      <td class="op-metroline">Metroline</td>
      <td>Edgware</td>
      <td><a href="https://maps.google.com/?q=Approach+Road,+Edgware,+HA8+7AN" target="_blank">Approach Road, HA8 7AN</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <tr>
      <td class="op-metroline">Metroline</td>
      <td>Harrow Weald</td>
      <td><a href="https://maps.google.com/?q=467+High+Road,+Harrow+Weald,+HA3+6EJ" target="_blank">467 High Road, HA3 6EJ</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <tr>
      <td class="op-metroline">Metroline</td>
      <td>Holloway</td>
      <td><a href="https://maps.google.com/?q=37A+Pemberton+Gardens,+London,+N19+5RR" target="_blank">37A Pemberton Gardens, N19 5RR</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <tr>
      <td class="op-metroline">Metroline</td>
      <td>Perivale (East)</td>
      <td><a href="https://maps.google.com/?q=Alperton+Lane,+Perivale,+UB6+8DW" target="_blank">Alperton Lane, UB6 8DW</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <tr>
      <td class="op-metroline">Metroline</td>
      <td>Potters Bar</td>
      <td><a href="https://maps.google.com/?q=High+Street,+Potters+Bar,+EN6+5BE" target="_blank">High Street, EN6 5BE</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <tr>
      <td class="op-metroline">Metroline</td>
      <td>Willesden</td>
      <td><a href="https://maps.google.com/?q=287+High+Road,+Willesden,+NW10+2JY" target="_blank">287 High Road, NW10 2JY</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <!-- First Bus London -->
    <tr>
      <td class="op-first">First Bus London</td>
      <td>Tolworth</td>
      <td><a href="https://maps.google.com/?q=180+Bromley+Road,+Catford,+SE6+2XA" target="_blank">180 Bromley Road, SE6 2XA</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <!-- Stagecoach London Plumstead -->
    <tr>
      <td class="op-stagecoach">Stagecoach</td>
      <td>Plumstead</td>
      <td><a href="https://maps.google.com/?q=Pettman+Crescent,+Plumstead,+SE28+0BJ" target="_blank">Pettman Crescent, SE28 0BJ</a></td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

    <!-- Twickenham with Fleet Vehicles (scrollable after 3 lines) -->
    <tr>
      <td class="op-abellio">Transport UK London Bus</td>
      <td>Fulwell (Twickenham)</td>
      <td><a href="https://maps.google.com/?q=The+Old+Tram+Depot,+Stanley+Road,+Twickenham,+TW2+5NP" target="_blank">Stanley Road, TW2 5NP</a></td>
      <td class="fleet-cell">
        6767 EY61UKJ - Ford Fiesta<br>
        6798 CA12MVC - Ford Fiesta<br>
        6827 FG68WDF - Vauxhall Astra<br>
        6831 HK67ERJ - Vauxhall Astra<br>
        6836 MV17LVH - Vauxhall Astra<br>
        6838 MT68FNA - Vauxhall Astra<br>
        6841 YJ66FMY - Peugeot 308<br>
        6842 AJ17MJK - Kia Ceed<br>
        6843 RE67CUH - Kia Proceed<br>
        6844 RJ66YXC - Kia Ceed<br>
        6845 OU68WLA - Peugeot 308<br>
        6851 BG18FFR - Seat Leon<br>
        6852 MT17UOC - Mazda 3<br>
        6856 OU17XZD - Volkswagen Golf<br>
        6857 MT67GVE - Renault Captur<br>
        6858 RA18XPX - SSANGYONG Tivoli<br>
        6860 NA17UMS - DS DS4<br>
        6865 YO17RUC - Seat Leon<br>
        6866 LS69MMF - Alfa Romeo Giulietta<br>
        6867 LR17EWY - Ford Focus<br>
        6868 HT17UYV - Renault Captur<br>
        6869 FP17ORK - Vauxhall Mokka<br>
        6907 MC19XNE - Peugeot Expert (Van)<br>
        6911 DV69EOO - Vauxhall Vivaro (Van)
      </td>
    </tr>

    <!-- Unassigned (if any) -->
    <tr>
      <td colspan="3" class="none">Unassigned Fleet Vehicles</td>
      <td class="fleet-cell none">No assigned fleet</td>
    </tr>

  </tbody>
</table>

<script>
function filterGarages(q) {
  q = q.toLowerCase();
  document.querySelectorAll('#garageTable tbody tr').forEach(r => {
    r.style.display = r.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}
</script>'>
    </iframe>

  </div>
</div>
<script>
document.getElementById('exportTxtBtn').onclick = () => {
  const rawText = resultsBox.textContent.trim();
  if (!rawText || rawText.startsWith('No')) {
    alert('No fleet numbers to export!');
    return;
  }

  // Split, clean, remove duplicates, and sort
  let fleetList = rawText
    .split(/[\s,]+/)
    .map(x => x.trim())
    .filter(x => x.length > 0);

  fleetList = [...new Set(fleetList)].sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

  // Format vertically, one per line, each ending with a comma
  const formattedText = fleetList.map(n => n + ',').join('\n');

  // Format filename as Clockwork_(DD-MM-YYYY).txt
  const today = new Date();
  const dateStr = `${String(today.getDate()).padStart(2,'0')}-${String(today.getMonth()+1).padStart(2,'0')}-${today.getFullYear()}`;
  const fileName = `Clockwork_${dateStr}.txt`;

  // Create and trigger download
  const blob = new Blob([formattedText], { type: 'text/plain' });
  const link = document.createElement('a');
  link.download = fileName;
  link.href = URL.createObjectURL(blob);
  link.click();
};
</script>
<script>
document.getElementById('exportTxtBtn').onclick = () => {
  const rawText = resultsBox.textContent.trim();
  if (!rawText || rawText.startsWith('No')) {
    alert('No fleet numbers to export!');
    return;
  }

  let fleetList = rawText
    .split(/[\s,]+/)
    .map(x => x.trim().toUpperCase())
    .filter(x => x.length > 0);

  fleetList = [...new Set(fleetList)].sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

  const groups = {};
  fleetList.forEach(item => {
    const prefix = /^[A-Z]+/.exec(item)?.[0] || 'NUM';
    if (!groups[prefix]) groups[prefix] = [];
    groups[prefix].push(item);
  });

  let formattedText = `- Asset Locator App -\n(Clockwork Schedule Fleet Numbers)\n\nFleet.\n`;

  Object.keys(groups).sort().forEach(prefix => {
    formattedText += groups[prefix].map(n => n + ',').join('\n');
    formattedText += '\n\n';
  });

  const today = new Date();
  const dateStr = `${String(today.getDate()).padStart(2,'0')}-${String(today.getMonth()+1).padStart(2,'0')}-${today.getFullYear()}`;
  const fileName = `Clockwork_${dateStr}.txt`;

  const blob = new Blob([formattedText], { type: 'text/plain' });
  const link = document.createElement('a');
  link.download = fileName;
  link.href = URL.createObjectURL(blob);
  link.click();
};
</script>
<script>
  const snowCount = 180;
  for (let i = 0; i < snowCount; i++) {
    const snow = document.createElement('div');
    snow.classList.add('snowflake');
    snow.style.left = Math.random() * window.innerWidth + 'px';
    snow.style.fontSize = (Math.random() * 10 + 10) + 'px';
    snow.style.animationDuration = (Math.random() * 5 + 5) + 's';
    snow.style.opacity = Math.random();
    snow.innerText = '‚ùÑÔ∏è';
    document.body.appendChild(snow);
  }
// ===== PARALLAX EFFECT =====
window.addEventListener('scroll', () => {
  const scrollY = window.scrollY;
  document.querySelector('.parallax-top').style.transform = `translateY(${scrollY*0.1}px)`;
  document.querySelector('.parallax-mid').style.transform = `translateY(${scrollY*0.3}px)`;
  document.querySelector('.parallax-bottom').style.transform = `translateY(${scrollY*0.5}px)`;
});
// ===== DOM ELEMENTS =====
const fileInput = document.getElementById('fileInput'),
      ocrPreview = document.getElementById('ocrPreview'),
      ocrLoader = document.getElementById('ocrLoader'),
      inputText = document.getElementById('inputText'),
      insertOCRBtn = document.getElementById('insertOCRBtn'),
      generateBtn = document.getElementById('generateBtn'),
      clearBtn = document.getElementById('clearBtn'),
      buttonsContainer = document.getElementById('buttonsContainer'),
      resultsBox = document.getElementById('resultsBox'),
      iframe = document.getElementById('viewerIframe'),
      operatorBtns = document.getElementsByClassName('operatorBtn'),
      copyBtn = document.getElementById('copyBtn'),
      ttsBtn = document.getElementById('ttsBtn'),
      pauseBtn = document.getElementById('pauseBtn'),
      exportImgBtn = document.getElementById('exportImgBtn'),
      operatorTitle = document.getElementById('operatorTitle'),
      themeBtn = document.getElementById('themeBtn');

const mediaBtn = document.getElementById('mediaBtn'),
      mediaModal = document.getElementById('mediaModal'),
      menuModal = document.getElementById('menuModal'),
      selectedModal = document.getElementById('selectedModal'),
      closeModal = document.getElementById('closeModal'),
      modelImage = document.getElementById('modelImage'),
      modalPrev = document.getElementById('modalPrev'),
      modalNext = document.getElementById('modalNext'),
      modalShare = document.getElementById('modalShare');

let lastOCRText = '',
    currentTemplate = 'https://lvf.io/#LDN|TL',
    currentColor = '#ef4444',
    lastPressedButton = null,
    currentSpeech = null,
    currentOperator = 'Abellio',
    imgX = 0, imgY = 0, isDragging = false, startX = 0, startY = 0,
    currentIndex = 0;

// ===== MEDIA IMAGES =====
const modelImages = [
"assets/USB3-RJ45-femfem.jpg",
"assets/USB3-USB-C.jpg",
"assets/USB2.0-RJ45 male2.jpg",
"assets/USB3.0-pinout.jpg",
"assets/RJ45-CrosOVR.jpg",
"assets/V400-SETUP..jpg",
"assets/T1600-ALARMS-I-0.jpg",
"assets/Cab-Switcher.jpg",
"assets/RJ45-PINOUT.jpg",
"assets/INHIBITOR-Recept-Rj10.jpg",
"assets/Receptacle-wiring.jpg",
"assets/Bus-Isolator.jpg",
"assets/FleetCars.jpg",
"assets/Edge.jpg",
"assets/CMS-block-dia.jpg",
"assets/EdgeOVERVIEW.jpg",
"assets/Folder Structure.jpg",
"assets/Garage-Entry-Codes.jpg",
"assets/CMS-Wiring-Whole.jpg",
"assets/DEMISTER-Pinout.jpg",
"assets/CMS-cam-apix-pinout.jpg",
"assets/CMS-MIRR-connc.jpg",
"assets/Can-wiring.jpg",
"assets/Can-Info.jpg",
"assets/DriversMic.jpg"
];

window.onload = () => {
  const saved = JSON.parse(localStorage.getItem('fleetButtons') || '[]');
  if (saved.length) buildButtons(saved);

  menuModal.innerHTML = '';

// Add model image buttons with filenames
modelImages.forEach((imgPath, index) => {
  const btn = document.createElement('button');
  btn.dataset.id = index;
  btn.style.display = 'flex';
  btn.style.flexDirection = 'column';
  btn.style.alignItems = 'center';
  btn.style.border = 'none';
  btn.style.background = 'transparent';
  btn.style.margin = '8px';

  const imgEl = document.createElement('img');
  imgEl.src = imgPath;
  imgEl.style.width = '120px';
  imgEl.style.height = 'auto';
  imgEl.style.borderRadius = '8px';

  const fileName = imgPath.split('/').pop();
  const caption = document.createElement('span');
  caption.textContent = fileName;
  caption.style.color = '#fff';
  caption.style.fontSize = '12px';
  caption.style.marginTop = '4px';
  caption.style.textAlign = 'center';

  btn.appendChild(imgEl);
  btn.appendChild(caption);
  btn.addEventListener('click', () => openMedia(index));

  menuModal.appendChild(btn);
});

  // PDF Submenu Button
  const pdfBtn = document.createElement('button');
  pdfBtn.className = 'pdf-submenu';
  pdfBtn.textContent = 'PDF Manual';
  const pdfPath = 'file:///storage/emulated/0/Download/TEMP MHTML/Lvf creation/HTML APP/www/APP Lvf/AssetLocator_FullPackage - TEST/assets/CCTV.pdf';
  pdfBtn.addEventListener('click', () => {
    try {
      let win = window.open(pdfPath, '_blank');
      if (!win) openPDF_WebViewSafe(pdfPath);
    } catch {
      openPDF_WebViewSafe(pdfPath);
    }
  });
  menuModal.appendChild(pdfBtn);
};


// ===== HELPERS =====
function scrollToSection(id){document.getElementById(id).scrollIntoView({behavior:'smooth',block:'center'});}

function extractFleetNumbers(text){
    if(!text) return [];
    const regex = /\b(?:Asset\s*No[:\-]?\s*)?([A-Z]{1,4}\d{1,5}|\d{3,6})\b/gi;
    let result=[],match;
    while((match=regex.exec(text))!==null){const val=match[1].toUpperCase();if(!result.includes(val)) result.push(val);}
    return result;
}

function buildButtons(list){
    buttonsContainer.innerHTML='';
    if(!list.length){buttonsContainer.innerHTML='<p style="opacity:.6">No valid numbers.</p>';return;}
    list.forEach(n=>{
        const b=document.createElement('button');
        b.textContent=n;
        b.className='asset-btn';
        b.onclick=()=>{
            if(lastPressedButton) lastPressedButton.classList.remove('pressed');
            b.classList.add('pressed'); lastPressedButton=b;
            iframe.classList.add('iframe-glow');
            iframe.src=currentTemplate+encodeURIComponent(' '+n);
            iframe.dataset.asset=n;
            iframe.style.borderColor=currentColor;
            setTimeout(()=>iframe.classList.remove('iframe-glow'),800);
        };
        buttonsContainer.appendChild(b);
    });
    localStorage.setItem('fleetButtons', JSON.stringify(list));
}

function generateFromInput(){
    const text=inputText.value.trim();
    const fleet=extractFleetNumbers(text);
    resultsBox.textContent=fleet.length?fleet.join(', '):'No valid fleet numbers found.';
    buildButtons(fleet);
}

// ===== THEME =====
themeBtn.onclick=()=>{document.body.classList.toggle('dark');document.body.classList.toggle('light');};

// ===== OPERATOR BUTTONS =====
[...operatorBtns].forEach(b=>{
    b.onclick=function(){
        [...operatorBtns].forEach(x=>x.classList.remove('active'));
        this.classList.add('active');
        currentTemplate=this.dataset.template;
        currentColor=this.dataset.color;
        currentOperator=this.dataset.name;
        operatorTitle.textContent=currentOperator;
    };
});

// ===== FILE OCR (Updated for Tesseract.js v5.0.1) =====
fileInput.addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async ev => {
    ocrLoader.style.display = 'block';
    ocrPreview.innerHTML = '<h2>Please Wait....</h2><marquee><h4>Filter / Extracts / Decipher Text with Asset/ Fleet numbers from image Using Javascript engines</h4><h2>Please hang-on a-min Asset Locator OCR will spit the results in course</h2></marquee><img src="assets/j-van.gif" alt="Processing..." style="width:100%;height:auto;border-radius:16px;box-shadow:0 4px 12px rgba(0,255,255,.3);">';

    try {
      const result = await Tesseract.recognize(
        ev.target.result,
        'eng',
        {
          logger: m => console.log(m),
        }
      );
      lastOCRText = (result.data.text || '').trim();
      ocrPreview.textContent = lastOCRText || 'No text detected';
if (lastOCRText) {
  insertOCRBtn.click();
}
    } catch (err) {
      ocrPreview.textContent = 'OCR Error: ' + err;
      console.error(err);
    } finally {
      ocrLoader.style.display = 'none';
    }
  };

  reader.readAsDataURL(file);
});

// ===== INSERT OCR =====
insertOCRBtn.onclick=()=>{
    if(!lastOCRText){alert('No OCR text to insert!'); return;}
    inputText.value=lastOCRText;
    generateFromInput();
    scrollToSection('buttonsContainer');
};

// ===== TTS =====
ttsBtn.onclick=()=>{
    const text=inputText.value.trim()||lastOCRText;
    if(!text){alert('No text to read aloud!'); return;}
    if(currentSpeech) speechSynthesis.cancel();
    currentSpeech=new SpeechSynthesisUtterance(text);
    currentSpeech.lang='en-GB';
    speechSynthesis.speak(currentSpeech);
    ttsBtn.textContent='Speaking...';
    currentSpeech.onend=()=>ttsBtn.textContent='?ÔøΩÔøΩ Read';
};
pauseBtn.onclick=()=>{
    if(!speechSynthesis.speaking) return;
    if(speechSynthesis.paused){speechSynthesis.resume(); pauseBtn.textContent='?ÔøΩÔ∏è';}
    else{speechSynthesis.pause(); pauseBtn.textContent='Paused..';}
};

// ===== GENERATE & CLEAR =====
generateBtn.onclick=generateFromInput;
clearBtn.onclick=()=>{
    inputText.value=''; resultsBox.textContent='No results yet.'; buttonsContainer.innerHTML='';
    iframe.src=''; lastOCRText=''; localStorage.removeItem('fleetButtons');
};

// ===== COPY =====
copyBtn.onclick=()=>{
    const text=resultsBox.textContent.trim();
    if(!text||text.startsWith('No')){alert('No fleet numbers to copy!'); return;}
    navigator.clipboard.writeText(text);
    copyBtn.textContent='?? Copied!';
    setTimeout(()=>copyBtn.textContent='?ÔøΩÔøΩ Copy Fleet Numbers',1500);
};

// ===== EXPORT PREVIEW =====
exportImgBtn.onclick=()=>{
    html2canvas(document.getElementById('previewContainer')).then(canvas=>{
        const asset=iframe.dataset.asset||'UNKNOWN';
        const now=new Date();
        const fname=`LVF-${asset}-${now.toISOString().slice(0,19).replace(/[:T]/g,'_')}.jpg`;
        canvas.toBlob(blob=>{
            const a=document.createElement('a');
            a.href=URL.createObjectURL(blob);
            a.download=fname;
            a.click();
        },'image/jpeg',0.95);
    });
};

// ===== MEDIA MENU & MODAL =====
function openMedia(index=0){
    currentIndex=index;
    modelImage.src=modelImages[currentIndex];
    menuModal.style.display='none';
    selectedModal.style.display='flex';
}

mediaBtn.onclick=()=>{mediaModal.style.display='flex';menuModal.style.display='grid';selectedModal.style.display='none';};
closeModal.onclick=()=>{selectedModal.style.display='none';menuModal.style.display='grid';};
mediaModal.onclick=e=>{if(e.target===mediaModal){mediaModal.style.display='none';selectedModal.style.display='none';menuModal.style.display='grid';}};
modalPrev.onclick=()=>{currentIndex=(currentIndex-1+modelImages.length)%modelImages.length;modelImage.src=modelImages[currentIndex];};
modalNext.onclick=()=>{currentIndex=(currentIndex+1)%modelImages.length;modelImage.src=modelImages[currentIndex];};
modalShare.onclick=()=>{let email=prompt('Enter email to share image:'); if(email){alert(`Shared image ${modelImage.src} to ${email}`);}};

// ===== TOUCH ZOOM & DRAG =====
let touchZoomLevel = 1;
const ZOOM_STEP = 0.5;
const MAX_ZOOM = 8;
let lastTap = 0;
let touchStartX = 0, touchStartY = 0;
let initialX = 0, initialY = 0;
let isTouchDragging = false;

function resetImageZoom() {
    touchZoomLevel = 1;
    imgX = 0; imgY = 0;
    modelImage.style.transform = `translate(0px,0px) scale(1)`;
}

modelImage.addEventListener('touchstart', function(e){
    if(e.touches.length === 1){
        const now = Date.now();
        if(now - lastTap < 300){
            resetImageZoom();
            lastTap = 0;
            return;
        }
        lastTap = now;

        touchStartX = e.touches[0].clientX - imgX;
        touchStartY = e.touches[0].clientY - imgY;
        initialX = imgX;
        initialY = imgY;
        isTouchDragging = true;
    }
});

modelImage.addEventListener('touchmove', function(e){
    if(!isTouchDragging) return;
    imgX = e.touches[0].clientX - touchStartX;
    imgY = e.touches[0].clientY - touchStartY;
    modelImage.style.transform = `translate(${imgX}px, ${imgY}px) scale(${touchZoomLevel})`;
    e.preventDefault();
},{passive:false});

modelImage.addEventListener('touchend', function(e){
    if(!isTouchDragging) return;
    isTouchDragging = false;
    if(Math.abs(imgX - initialX) < 5 && Math.abs(imgY - initialY) < 5){
        touchZoomLevel = Math.min(MAX_ZOOM, touchZoomLevel + ZOOM_STEP);
        modelImage.style.transform = `translate(${imgX}px, ${imgY}px) scale(${touchZoomLevel})`;
    }
});

// ===== MOUSE DRAG =====
modelImage.onmousedown=e=>{isDragging=true;startX=e.clientX-imgX;startY=e.clientY-imgY;modelImage.style.cursor='grabbing';};
document.onmousemove=e=>{if(!isDragging) return; imgX=e.clientX-startX; imgY=e.clientY-startY; modelImage.style.transform=`translate(${imgX}px,${imgY}px)`;};
document.onmouseup=()=>{isDragging=false; modelImage.style.cursor='grab';};

// ===== WEBVIEW-SAFE PDF OPENER =====
function openPDF_WebViewSafe(path) {
    const frame = document.createElement("iframe");
    frame.style.display = "none";
    frame.src = path;
    document.body.appendChild(frame);

    setTimeout(() => {
        alert("If the PDF did not open, your WebView may block external PDF intents.\nTry an external PDF viewer.");
    }, 800);
}

// ===== LOAD HISTORY & POPULATE MENU =====
window.onload=()=>{
    const saved=JSON.parse(localStorage.getItem('fleetButtons')||'[]');
    if(saved.length) buildButtons(saved);

    menuModal.innerHTML='';

    // Add model image buttons
    modelImages.forEach((imgPath,index)=>{
        const btn=document.createElement('button');
        btn.dataset.id=index;
        const imgEl=document.createElement('img');
        imgEl.src=imgPath;
        btn.appendChild(imgEl);
const fileName = imgPath.split('/').pop();
btn.appendChild(document.createTextNode(fileName));

        btn.addEventListener("click",()=>openMedia(index));
        menuModal.appendChild(btn);
    });

    // PDF Submenu Button (WebView safe)
    const pdfBtn=document.createElement('button');
    pdfBtn.className='pdf-submenu';
    pdfBtn.textContent='PDF Manual';

    // **Your PDF Path**
    const pdfPath = "content://com.mixplorer.file/509!/TEMP%20MHTML/Lvf%20creation/HTML%20APP/www/APP%20Lvf/AssetLocator_FullPackage%20-%20TEST/assets/CCTV..pdf";

    pdfBtn.addEventListener("click", () => {
        try {
            let win = window.open(pdfPath, "_blank");
            if (!win) openPDF_WebViewSafe(pdfPath);
        } catch {
            openPDF_WebViewSafe(pdfPath);
        }
    });

    menuModal.appendChild(pdfBtn);
};

let snowflakes = Array.from(document.getElementsByClassName('snowflake'));
let snowToggleState = 2; // 1 = slow, 2 = stop, 3 = fast

function updateSnow() {
    if(!document.body.classList.contains('dark')) {
        snowflakes.forEach(s => s.style.display = 'none');
        return;
    }
    snowflakes.forEach(s => s.style.display = 'block');
    snowflakes.forEach(s => {
        let baseSize = parseFloat(s.style.fontSize) || 10;
        if(snowToggleState === 1) s.style.animationDuration = (Math.random()*5 + 5)+'s'; // slow
        else if(snowToggleState === 2) s.style.display = 'none'; // stop
        else if(snowToggleState === 3) s.style.animationDuration = (Math.random()*2 + 1)+'s'; // fast
    });
}

// Add small snow toggle button
const snowBtn = document.createElement('button');
snowBtn.className = 'tiny-btn';
snowBtn.style.position = 'fixed';
snowBtn.style.top = '130px';
snowBtn.style.right = '25px';
snowBtn.style.width = '70px'; // wider button
snowBtn.style.height = '30px';
snowBtn.style.display = 'flex';
snowBtn.style.alignItems = 'center';
snowBtn.style.justifyContent = 'center';
snowBtn.style.gap = '8px';
snowBtn.style.background = 'rgba(255, 255, 255, 0.15)';
snowBtn.style.border = '1px solid #B155CC';
snowBtn.style.borderRadius = '10px';
snowBtn.style.color = '#fff';
snowBtn.style.cursor = 'pointer';
snowBtn.style.fontSize = '15px';
snowBtn.style.backdropFilter = 'blur(6px)';
snowBtn.style.boxShadow = '0 0 10px rgba(255,255,255,0.3)';

// add snow icon
const img = document.createElement('img');
img.src = 'assets/snow.gif';
img.alt = 'Snow';
img.style.width = '30px';
img.style.height = '30px';

// add text
const text = document.createElement('span');
text.textContent = '‚ùÑÔ∏èSnow‚ùÑÔ∏è';

// append icon + text to button
snowBtn.appendChild(img);
snowBtn.appendChild(text);
document.body.appendChild(snowBtn);

// button click toggle
snowBtn.onclick = () => {
    snowToggleState++;
    if (snowToggleState > 3) snowToggleState = 0;
    updateSnow();
};

// Update snow when theme changes
themeBtn.onclick = () => {
    document.body.classList.toggle('dark');
    document.body.classList.toggle('light');
    updateSnow();
};

// Initialize snow on load
updateSnow();
</script>
<script type="x-shader/x-fragment" id="fragmentShader">
  varying vec2 vUv;
  uniform float u_ratio;
  uniform float u_time;
  uniform vec2 u_mouse;
  uniform vec2 u_target_mouse;
  uniform float u_face_expression;
  uniform sampler2D u_touch_texture;

  // Ghost face
  float eyes(vec2 _st) {
    _st.x = abs(_st.x);
    _st.y += pow(_st.x, 2. - .4 * u_face_expression);
    _st.x -= (.08 + .03 * u_face_expression);
    _st.y *= .8;
    _st *= 10.;
    float d = length(_st);
    d = pow(d, .4);
    return clamp(1. - d, 0., 1.);
  }

  float mouth(vec2 _st) {
    _st *= 13.;
    _st.y *= .8;
    _st.x /= (1. + 2. * u_face_expression);
    _st.y *= (1. + .7 * u_face_expression);
    _st.y -= pow(_st.x, 2.) * 2. * u_face_expression;
    float d = length(_st);
    d = pow(d, .7);
    return clamp(1. - d, 0., 1.);
  }

  float face(vec2 _st) {
    _st *= 3.5;
    float eyes_shape = eyes(_st - vec2(0., .1));
    float mouth_shape = mouth(_st - vec2(0., -.2));
    float col = 0.0; // initialized
    col = mix(col, 1., eyes_shape);
    col = mix(col, 1., mouth_shape);
    return col;
  }

  // 2D noise
  vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
  vec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
  vec3 permute(vec3 x) { return mod289(((x*34.0)+1.0)*x); }
  float snoise(vec2 v) {
    const vec4 C = vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);
    vec2 i  = floor(v + dot(v, C.yy) );
    vec2 x0 = v -   i + dot(i, C.xx);
    vec2 i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
    vec4 x12 = x0.xyxy + C.xxzz;
    x12.xy -= i1;
    i = mod289(i);
    vec3 p = permute( permute( i.y + vec3(0.0, i1.y, 1.0 )) + i.x + vec3(0.0, i1.x, 1.0 ));
    vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
    m = m*m ; m = m*m ;
    vec3 x = 2.0 * fract(p * C.www) - 1.0;
    vec3 h = abs(x) - 0.5;
    vec3 ox = floor(x + 0.5);
    vec3 a0 = x - ox;
    m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
    vec3 g;
    g.x  = a0.x  * x0.x  + h.x  * x0.y;
    g.yz = a0.yz * x12.xz + h.yz * x12.yw;
    return 130.0 * dot(m, g);
  }

  void main() {
    vec2 st = vUv;
    vec2 mouse = st - u_mouse.xy;
    mouse.x *= u_ratio;
    vec2 mouse_target = st - u_target_mouse.xy;
    mouse_target.x *= u_ratio;

    float touch = texture2D(u_touch_texture, st).r;

    vec2 noise_pos = vec2(st * 6.);
    float noise = snoise(noise_pos + vec2(0., u_time)) * .25 + .25;
    noise += snoise(noise_pos) * .25 + .3;
    touch *= noise;

    touch -= 1.2 * face(mouse - .1 * (mouse - mouse_target));

    vec3 color = mix(vec3(.184, .282, .345), vec3(.945, .945, .902), smoothstep(.01, .38, touch));

    gl_FragColor = vec4(color, 1.);
  }
</script>

<script type="x-shader/x-vertex" id="vertexShader">
  varying vec2 vUv;
  void main() {
    vUv = uv;
    gl_Position = vec4(position, 1.);
  }
</script>
<script type="module">
import * as THREE from 'assets/three.module.min.js';

let config = {
    dotsNumber: 11,
    dotsBaseRadius: window.innerHeight * .1,
    tailSpring: .35,
    tailGravity: window.innerHeight * .005,
    tailGravityBonds: [window.innerHeight * .005, window.innerHeight * .01],
    tailFriction: .5,
    faceExpression: 0,
    catchingSpeed: window.innerWidth * .0001,
};

class Viz {
    constructor() {
        this.renderer = new THREE.WebGLRenderer({});
        this.container = document.getElementsByClassName('viz')[0];
        this.container.appendChild(this.renderer.domElement);

        this.camera = new THREE.OrthographicCamera(
            -.5 * window.innerWidth, .5 * window.innerWidth,
            .5 * window.innerHeight, -.5 * window.innerHeight,
            0.1, 10
        );
        this.camera.position.set(0, 0, 1);

        this.clock = new THREE.Clock();
        this.scene = new THREE.Scene();

        this.touchPoint = new THREE.Vector2(.5, .65);
        this.targetTouchPoint = new THREE.Vector2(.5, .65);
        this.touchCanvasPoint = [ this.touchPoint.x * window.innerWidth, (1 - this.touchPoint.y) * window.innerHeight ];
        this.isMoving = false;

        this.touchCanvas = document.createElement('canvas');
        this.touchCanvasCtx = this.touchCanvas.getContext('2d');
        this.touchTexture = new THREE.CanvasTexture(this.touchCanvas);
        this.touchTrail = new Array(config.dotsNumber);
        for (let i = 0; i < config.dotsNumber; i++) {
            this.touchTrail[i] = {
                x: this.touchCanvasPoint[0],
                y: this.touchCanvasPoint[1],
                vx: 0, vy: 0,
                intensity: i ? .6 * (config.dotsNumber - i) / config.dotsNumber : .9,
                r: config.dotsBaseRadius * (1 + Math.pow(i / config.dotsNumber, .5))
            };
        }

        this.material = new THREE.ShaderMaterial({
            uniforms: {
                u_touch_texture: {value: this.touchTexture},
                u_mouse: { value: new THREE.Vector2(0, 0) },
                u_target_mouse: { value: new THREE.Vector2(0, 0) },
                u_resolution: { value: new THREE.Vector2(0, 0) },
                u_time: { value: 0 },
                u_face_expression: { value: config.faceExpression },
                u_ratio: { value: window.innerWidth / window.innerHeight },
            },
            vertexShader: document.getElementById('vertexShader').textContent,
            fragmentShader: document.getElementById('fragmentShader').textContent
        });

        const planeGeometry = new THREE.PlaneBufferGeometry(2, 2);
        this.scene.add(new THREE.Mesh(planeGeometry, this.material));

        this.addCanvasEvents();
    }

    addCanvasEvents() {
        const _this = this;
        let movingTimer;
        let movingTimeout = function () { _this.isMoving = false; };
        movingTimer = setTimeout(movingTimeout, 300);

        window.addEventListener('mousemove', (e) => updateMousePosition(e.clientX, e.clientY));
        window.addEventListener('touchmove', (e) => updateMousePosition(e.targetTouches[0].pageX, e.targetTouches[0].pageY));

        function updateMousePosition(eX, eY) {
            if (!_this.isMoving) _this.isMoving = true;
            clearTimeout(movingTimer);
            movingTimer = setTimeout(movingTimeout, 300);
            _this.targetTouchPoint.x = eX / window.innerWidth;
            _this.targetTouchPoint.y = 1 - eY / window.innerHeight;
        }
    }

    updateTrail() {
        this.touchCanvasCtx.fillStyle = 'black';
        this.touchCanvasCtx.fillRect(0, 0, this.touchCanvas.width, this.touchCanvas.height);

        this.touchTrail.forEach((p, pIdx) => {
            if (pIdx === 0) {
                p.x = this.touchCanvasPoint[0];
                p.y = this.touchCanvasPoint[1];
            } else {
                p.vx += (this.touchTrail[pIdx - 1].x - p.x) * config.tailSpring;
                p.vx *= config.tailFriction;
                p.vy += (this.touchTrail[pIdx - 1].y - p.y) * config.tailSpring;
                p.vy += config.tailGravity;
                p.vy *= config.tailFriction;
                p.x += p.vx;
                p.y += p.vy;
            }

            const grd = this.touchCanvasCtx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r);
            grd.addColorStop(0, 'rgba(255, 255, 255, ' + p.intensity + ')');
            grd.addColorStop(1, 'rgba(255, 255, 255, 0)');

            this.touchCanvasCtx.beginPath();
            this.touchCanvasCtx.fillStyle = grd;
            this.touchCanvasCtx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            this.touchCanvasCtx.fill();
        });

        this.touchTexture.needsUpdate = true;
    }

    render() {
        this.touchPoint.x += (this.targetTouchPoint.x - this.touchPoint.x) * config.catchingSpeed;
        this.touchPoint.y += (this.targetTouchPoint.y - this.touchPoint.y) * config.catchingSpeed;
        this.touchCanvasPoint = [ this.touchPoint.x * window.innerWidth, (1 - this.touchPoint.y) * window.innerHeight ];

        const time = this.clock.getElapsedTime();

        if (this.isMoving) {
            config.faceExpression = Math.max(config.faceExpression - .05, 0);
            config.tailGravity = Math.max(config.tailGravity - .1, config.tailGravityBonds[0]);
        } else {
            config.faceExpression = Math.min(config.faceExpression + .01, 1);
            config.tailGravity = Math.min(config.tailGravity + .1, config.tailGravityBonds[1]);
        }
        config.tailGravity += .12 * Math.sin(3 * time);

        this.material.uniforms.u_face_expression.value = config.faceExpression;
        this.updateTrail();
        this.material.uniforms.u_touch_texture.value = this.touchTexture;
        this.material.uniforms.u_time.value = time;
        this.material.uniforms.u_mouse.value.set(this.touchPoint.x, this.touchPoint.y);
        this.material.uniforms.u_target_mouse.value.set(this.targetTouchPoint.x, this.targetTouchPoint.y);
        this.renderer.render(this.scene, this.camera);
    }

    loop() { this.render(); requestAnimationFrame(this.loop.bind(this)); }

    updateSize() {
        config.dotsBaseRadius = window.innerHeight * .1;
        config.tailGravity = window.innerHeight * .005;
        config.tailGravityBonds = [window.innerHeight * .005, window.innerHeight * .01];
        config.catchingSpeed = window.innerWidth * .0001;

        this.touchCanvas.width = window.innerWidth;
        this.touchCanvas.height = window.innerHeight;
        this.camera.left = -.5 * window.innerWidth;
        this.camera.right = .5 * window.innerWidth;
        this.camera.top = .5 * window.innerHeight;
        this.camera.bottom = -.5 * window.innerHeight;
        this.camera.updateProjectionMatrix();

        this.material.uniforms.u_ratio.value = window.innerWidth / window.innerHeight;
        this.material.uniforms.u_resolution.value.set(window.innerWidth, window.innerHeight);
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    }
}

const viz = new Viz();
viz.updateSize();
window.addEventListener('resize', () => viz.updateSize());
viz.loop();
</script>
<script>
(() => {
  const btn = document.getElementById('garageRefBtn');
  const modal = document.getElementById('garageRefModal');
  const close = document.getElementById('garageRefClose');

  btn.onclick = () => modal.style.display = 'block';
  close.onclick = () => modal.style.display = 'none';
  modal.onclick = e => { if(e.target === modal) modal.style.display = 'none'; };
})();
</script>
<script>
/* ===== GARAGE REFERENCE ‚Äì LOGIC ===== */
const garageRefBtn   = document.getElementById('garageRefBtn');
const garageRefModal = document.getElementById('garageRefModal');
const garageRefClose = document.getElementById('garageRefClose');

garageRefBtn.onclick = () => {
  garageRefModal.style.display = 'block';
};

garageRefClose.onclick = () => {
  garageRefModal.style.display = 'none';
};

garageRefModal.onclick = (e) => {
  if (e.target === garageRefModal) {
    garageRefModal.style.display = 'none';
  }
};
</script>
<script src="assets/html2canvas.min.js"></script>
<script src="assets/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const notebook = document.getElementById("notebook");
  const loginnRefBtn = document.getElementById("loginnRefBtn");
  const loginnRefModal = document.getElementById("loginnRefModal");
  const closeBtn = document.querySelector(".close");
  const editSaveBtn = document.getElementById("editSaveBtn");
  const exitBtn = document.getElementById("exitBtn");
  const insertImgBtn = document.getElementById("insertImgBtn");
  const imgInput = document.getElementById("imgInput");
  const clearAllBtn = document.getElementById("clearAllBtn");
  const undoBtn = document.getElementById("undoBtn");
  const redoBtn = document.getElementById("redoBtn");
  const exportBtn = document.getElementById("exportBtn");
  const accessPassword = "21";

  let historyStack=[], redoStack=[], lastClickX=0, lastClickY=0;

  // --- Modal ---
  loginnRefBtn.onclick = () => {
    const pass = prompt("Enter password:");
    if(pass===accessPassword){
      notebook.contentEditable=false;
      editSaveBtn.textContent="Edit";
      loginnRefModal.style.display="flex";
      loadNotebook();
    } else if(pass!==null) alert("Incorrect password!");
  };
  closeBtn.onclick = exitBtn.onclick = ()=>loginnRefModal.style.display="none";
  window.onclick = e=>{ if(e.target===loginnRefModal) loginnRefModal.style.display="none"; };

  // --- Click tracking for image placement ---
  notebook.addEventListener("click", e => {
    const nbRect = notebook.getBoundingClientRect();
    lastClickX = e.clientX - nbRect.left;
    lastClickY = e.clientY - nbRect.top;
  });

  // --- History ---
  function addHistory(){ historyStack.push(notebook.innerHTML); if(historyStack.length>50) historyStack.shift(); }
  function saveNotebook(){ addHistory(); localStorage.setItem("loginNotebook", notebook.innerHTML); }

  undoBtn.onclick = ()=>{
    if(historyStack.length>1){
      redoStack.push(historyStack.pop());
      notebook.innerHTML = historyStack[historyStack.length-1];
      setupImages();
    }
  };
  redoBtn.onclick = ()=>{
    if(redoStack.length>0){
      notebook.innerHTML = redoStack.pop();
      setupImages();
    }
  };

  // --- Edit / Save ---
  editSaveBtn.onclick = ()=>{ 
    notebook.isContentEditable ? (notebook.contentEditable=false, saveNotebook(), editSaveBtn.textContent="Edit") 
                              : (notebook.contentEditable=true, editSaveBtn.textContent="Save"); 
  };

  // --- Clear All ---
  clearAllBtn.onclick = ()=>{
    if(confirm("Are you sure you want to delete all notes?")){
      notebook.innerHTML=""; historyStack=[]; redoStack=[];
      saveNotebook();
    }
  };

  // --- Insert Image ---
  insertImgBtn.onclick = ()=> notebook.isContentEditable ? imgInput.click() : alert("Enable edit mode");
  imgInput.onchange = e=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      const wrapper = document.createElement("div"); wrapper.className="img-wrapper";
      wrapper.style.left = lastClickX+"px"; wrapper.style.top = lastClickY+"px";

      const img = document.createElement("img"); img.src = ev.target.result; wrapper.appendChild(img);
      const handle = document.createElement("div"); handle.className="handle"; handle.textContent="‚áÖ"; wrapper.appendChild(handle);

      notebook.appendChild(wrapper);
      setupDrag(wrapper, handle); setupDelete(img, wrapper);
      saveNotebook();
    };
    reader.readAsDataURL(file); imgInput.value="";
  };

  // --- Delete & Drag ---
  function setupDelete(img, wrapper){
    let lastTap=0;
    img.addEventListener("touchend", e=>{ const now=Date.now(); if(now-lastTap<400 && now-lastTap>0){ wrapper.remove(); saveNotebook(); } lastTap=now; });
    img.addEventListener("dblclick", ()=>{ wrapper.remove(); saveNotebook(); });
  }

  function setupDrag(wrapper, handle){
    let offsetX=0, offsetY=0, isDragging=false;

    const startDrag = e => {
      if(!notebook.isContentEditable) return;
      isDragging = true;
      const rect = wrapper.getBoundingClientRect();
      const clientX = e.clientX || e.touches[0].clientX;
      const clientY = e.clientY || e.touches[0].clientY;
      offsetX = clientX - rect.left;
      offsetY = clientY - rect.top;
      e.preventDefault();
    };

    const dragMove = e => {
      if(!isDragging) return;
      e.preventDefault();
      const clientX = e.clientX || e.touches[0].clientX;
      const clientY = e.clientY || e.touches[0].clientY;
      let x = clientX - offsetX;
      let y = clientY - offsetY;
      const nbRect = notebook.getBoundingClientRect();
      x=Math.max(0,Math.min(x,nbRect.width-wrapper.offsetWidth));
      y=Math.max(0,Math.min(y,nbRect.height-wrapper.offsetHeight));
      wrapper.style.left=x+"px"; wrapper.style.top=y+"px";
    };

    const endDrag = ()=>{ if(isDragging){ isDragging=false; saveNotebook(); } };

    handle.addEventListener("mousedown", startDrag);
    handle.addEventListener("touchstart", startDrag, {passive:false});
    document.addEventListener("mousemove", dragMove);
    document.addEventListener("mouseup", endDrag);
    document.addEventListener("touchmove", dragMove, {passive:false});
    document.addEventListener("touchend", endDrag);
  }

  function setupImages(){
    notebook.querySelectorAll(".img-wrapper").forEach(wrapper=>{
      const handle=wrapper.querySelector(".handle"); if(handle) setupDrag(wrapper, handle);
      const img=wrapper.querySelector("img"); if(img) setupDelete(img, wrapper);
    });
  }

  // --- Load notebook ---
  function loadNotebook(){
    notebook.innerHTML = localStorage.getItem("loginNotebook") || "Engineers notes - important info goes in here ok? good, now chop chop.. ";
    setupImages();
    addHistory();
  }

  // --- Export PDF ---
  exportBtn.onclick = async ()=>{
    try{
      const { jsPDF } = window.jspdf;
      const clone = notebook.cloneNode(true);
      clone.querySelectorAll('.handle').forEach(h=>h.remove()); // remove handles
      clone.style.width="800px"; clone.style.height="auto";

      const canvas = await html2canvas(clone, { scale:2, useCORS:true, allowTaint:false });
      const imgData = canvas.toDataURL("image/png");
      const pdf = new jsPDF('p','pt','a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = pageWidth-20;
      const scale = imgWidth/canvas.width;
      const imgHeight = canvas.height*scale;

      let heightLeft = imgHeight, position=10;
      pdf.addImage(imgData,'PNG',10,position,imgWidth,imgHeight);
      heightLeft -= pageHeight;
      while(heightLeft>0){
        pdf.addPage();
        position = heightLeft - imgHeight +10;
        pdf.addImage(imgData,'PNG',10,position,imgWidth,imgHeight);
        heightLeft -= pageHeight;
      }
      pdf.save("notebook_export.pdf");
    }catch(err){ console.error(err); alert("PDF export failed, check console."); }
  };
});
</script>
<script>
const themeBtn = document.getElementById('themeBtn');

themeBtn.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  document.body.classList.toggle('light');

  const isDark = document.body.classList.contains('dark');
  localStorage.setItem('theme', isDark ? 'dark' : 'light');

  themeBtn.style.animation = 'none';
  setTimeout(() => themeBtn.style.animation = isDark ? 'neonPulse 2.5s infinite alternate' : 'none', 100);
});

window.addEventListener('DOMContentLoaded', () => {
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.body.classList.add(savedTheme);
});
</script>
<script>
    const openBtn = document.getElementById('openBtn');
    const closeBtn = document.getElementById('closeBtn');
    const overlay = document.getElementById('overlay');

    openBtn.addEventListener('click', () => {
      overlay.classList.add('active');
    });

    closeBtn.addEventListener('click', () => {
      overlay.classList.remove('active');
    });

    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        overlay.classList.remove('active');
      }
    });
  </script>

</body>
</html>
